name: Validate Kustomize Configurations

on:
  push:

jobs:
  validate-kustomize:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Find and validate Kustomize configurations
      id: validate
      run: |
        echo "# Kustomize Validation Results"
        echo ""
        echo "# Kustomize Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Find all kustomization.yaml files
        KUSTOMIZATION_DIRS=$(find . -name "kustomization.yaml" -exec dirname {} \;)

        # Check if any kustomization files were found
        if [ -z "$KUSTOMIZATION_DIRS" ]; then
          echo "â„¹ï¸ No kustomization.yaml files found"
          echo "### â„¹ï¸ No kustomization.yaml files found" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi

        # Initialize error flag
        HAS_ERRORS=0

        # Test each kustomization
        for dir in $KUSTOMIZATION_DIRS; do
          echo "ðŸ” Validating: $dir"
          if ! OUTPUT=$(kustomize build "$dir" --enable-helm 2>&1); then
            echo ""
            echo "âŒ Error in '$dir':"
            echo "----------------------------------------"
            echo "$OUTPUT"
            echo "----------------------------------------"
            echo ""
            
            # Also add to GitHub step summary
            echo "### âŒ Error in \`$dir\`" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            HAS_ERRORS=1
          else
            echo "âœ… $dir is valid"
          fi
        done

        if [ "$HAS_ERRORS" -eq 1 ]; then
          echo ""
          echo "ðŸš¨ One or more kustomizations failed validation."
          echo "::error::One or more Kustomize configurations failed validation"
          exit 1
        else
          echo ""
          echo "ðŸŽ‰ All kustomizations are valid."
          echo "### ðŸŽ‰ All kustomizations are valid!" >> $GITHUB_STEP_SUMMARY
        fi